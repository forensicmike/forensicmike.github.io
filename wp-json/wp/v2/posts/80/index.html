{"id":80,"date":"2019-04-28T07:32:50","date_gmt":"2019-04-28T14:32:50","guid":{"rendered":"https:\/\/3.88.229.156\/?p=80"},"modified":"2019-05-19T18:49:25","modified_gmt":"2019-05-20T01:49:25","slug":"aggregating-ios-powerlog-data-using-c-part-1","status":"publish","type":"post","link":"http:\/\/172.31.17.250\/2019\/04\/28\/aggregating-ios-powerlog-data-using-c-part-1\/","title":{"rendered":"Aggregating iOS PowerLog data using C# &#8211; Part 1"},"content":{"rendered":"\n<p>If you haven&#8217;t already heard of Sarah Edwards&#8217; <a href=\"https:\/\/github.com\/mac4n6\/APOLLO\">APOLLO<\/a> (Apple Pattern of Life Lazy Output&#8217;er), you should probably stop reading this and go check that out first. This article builds on Sarah&#8217;s work, specifically with PowerLogs. <\/p>\n\n\n\n<p>One of the challenges with PowerLogs is that on a daily basis, the device dumps the contents into a compressed archive. This makes sense from Apple&#8217;s perspective but makes it difficult \/ tedious to query en masse for forensic analysis. Our task today will be to programmatically combine data into a unified dataset upon which we can then run our APOLLO queries.<\/p>\n\n\n\n<p>For this work, I&#8217;m going to leverage my own <a href=\"https:\/\/github.com\/forensicmike\/gkziplib\">GKZipLib<\/a>, which is a custom ZIP parsing module I created after becoming frustrated with the sluggish  performance of open source ZIP libraries available (including the ones native to .NET) for archives of significant size. My research iPhone filesystem is only a 15GB archive, but using GKZipLib parsing 271,361 entries to locate PowerLogs took my machine&#8217;s dated hardware a whole 0.5 seconds to complete. <\/p>\n\n\n\n<p>Finally, I&#8217;ll be using <a href=\"https:\/\/www.linqpad.net\/\">LINQPad<\/a>, Joe Albahari&#8217;s massively useful creation that has become a critical part of my day to day work. If you do any .NET coding at all, this is a wonderful tool to have in your arsenal for everything from quick and dirty analytical tasks to developing proof of concept code that can ultimately mature into a fully fledged Windows app in future.<\/p>\n\n\n\n<p>So let&#8217;s get started. We&#8217;ll begin with a few preparatory steps:<\/p>\n\n\n\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"csharp\" data-enlighter-theme=\"droide\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"false\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\">\/\/ Instantiate our archive\nvar iphoneZip = new GKZipFile(@\"D:\\a769****_files.zip\", false);\n\n\/\/ Pattern to find our GZipped powerlogs\nRegex rgxPowerLog = new Regex(@\"powerlog_[\\w\\W]*?\\.PLSQL\\.gz\");\n\n\/\/ Place to export all the things\nvar outputPath = Directory.CreateDirectory(@\"c:\\temp\\plUnity\\\");\n\n\/\/ Who doesn't love stats?\nvar filesParsed = 0;\nvar filesExtracted = 0;<\/pre>\n\n\n\n<p>From here, thanks to the power of LINQ and the implementation of the IEnumerable interface by GKZipFile, it&#8217;s as simple as iterating our archive like it&#8217;s a giant array with foreach.<\/p>\n\n\n\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"csharp\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\">foreach (var file in iphoneZip)\n{\n\t\/\/ Check for a GZ powerlog archive.\n\tif (rgxPowerLog.IsMatch(file.ShortName))\n\t{\n\t\tConsole.WriteLine($\"Extracting {file.Name}...\");\n\t\tfile.ExtractToFolder(outputPath.FullName);\n\t\tfilesExtracted++;\n\t}\n\t\/\/ As well as the 'CurrentPowerLog'\n\t\/\/ By using IndexOf instead of Contains, we ensure to snag any -shm and -wal files as well\n\tif (file.ShortName.IndexOf(\"CurrentPowerLog.PLSQL\", StringComparison.CurrentCultureIgnoreCase) >= 0)\n\t{\n\t\tConsole.WriteLine($\"Extracting {file.Name}...\");\n\t\tfile.ExtractToFolder(outputPath.FullName);\n\t\tfilesExtracted++;\n\t}\n\t\n\t\/\/ Count of files parsed\n\tfilesParsed++;\n}\n\nConsole.WriteLine($\"Finished parsing {filesParsed} files.\");\nConsole.WriteLine($\"A total of {filesExtracted} files were extracted.\");<\/pre>\n\n\n\n<p>Output:<\/p>\n\n\n\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"raw\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\">Extracting \/private\/var\/containers\/Shared\/SystemGroup\/BCBD844C-BDB8-4D6B-8246-555182B5F39A\/Library\/BatteryLife\/Archives\/powerlog_2018-10-07_7F9FC438.PLSQL.gz...\nExtracting \/private\/var\/containers\/Shared\/SystemGroup\/BCBD844C-BDB8-4D6B-8246-555182B5F39A\/Library\/BatteryLife\/Archives\/powerlog_2018-10-08_2162C03C.PLSQL.gz...\nExtracting \/private\/var\/containers\/Shared\/SystemGroup\/BCBD844C-BDB8-4D6B-8246-555182B5F39A\/Library\/BatteryLife\/Archives\/powerlog_2018-10-09_0DC64180.PLSQL.gz...\nExtracting \/private\/var\/containers\/Shared\/SystemGroup\/BCBD844C-BDB8-4D6B-8246-555182B5F39A\/Library\/BatteryLife\/Archives\/powerlog_2018-10-10_24F9BF01.PLSQL.gz...\nExtracting \/private\/var\/containers\/Shared\/SystemGroup\/BCBD844C-BDB8-4D6B-8246-555182B5F39A\/Library\/BatteryLife\/CurrentPowerlog.PLSQL-shm...\nExtracting \/private\/var\/containers\/Shared\/SystemGroup\/BCBD844C-BDB8-4D6B-8246-555182B5F39A\/Library\/BatteryLife\/CurrentPowerlog.PLSQL-wal...\nExtracting \/private\/var\/containers\/Shared\/SystemGroup\/BCBD844C-BDB8-4D6B-8246-555182B5F39A\/Library\/BatteryLife\/CurrentPowerlog.PLSQL...\nFinished parsing 271361 files.\nA total of 7 files were extracted.\n\n<\/pre>\n\n\n\n<p>The final thing we will do in part 1 is extract our GZ files in place so that they are accessible for querying. To simplify things, I wrote a function to do this which simply removes the GZ extension to determine the output filename. This logic could certainly be flawed for a generic GZ decompression routine but in this case we can rely on the fact that our GZipped files will have the .GZ extension.<\/p>\n\n\n\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"csharp\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\">void GZExtract(string inputFile)\n{\n\tusing (var fs = new FileStream(inputFile, FileMode.Open, FileAccess.Read, FileShare.Read))\n\t{\n\t\tusing (var gzstr = new GZipStream(fs, CompressionMode.Decompress))\n\t\t{\n\t\t\tconst int buffSize = 4096;\n\t\t\tbyte[] buffer = new byte[buffSize];\n\t\t\tusing (var uncompressedData = new FileStream(inputFile.Replace(\".gz\", \"\"), FileMode.Create))\n\t\t\t{\n\t\t\t\tvar bytesRead = 0;\n\t\t\t\tdo\n\t\t\t\t{\n\t\t\t\t\tbytesRead = gzstr.Read(buffer, 0, buffSize);\n\t\t\t\t\tif (bytesRead > 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tuncompressedData.Write(buffer, 0, bytesRead);\n\t\t\t\t\t}\n\t\t\t\t} while (bytesRead > 0);\n\n\t\t\t}\n\t\t}\n\t}\n}<\/pre>\n\n\n\n<p>And finally, invoke the function for each of our GZ powerlogs:<\/p>\n\n\n\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"csharp\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\">\/\/ Decompress all of our gzipped archives\nforeach (var arc in outputPath.GetFiles(\"*.gz\"))\n{\n\tGZExtract(arc.FullName);\n}<\/pre>\n\n\n\n<p>That&#8217;s where we will end off today. Here&#8217;s what we&#8217;ve completed so far:<\/p>\n\n\n\n<ul><li>Iterate the iOS filesystem archive, locate files of interest including CurrentPowerLog.PLSQL and associated SQLite artifacts and any GZipped archives, and extracted them to the local machine.<\/li><li>Decompress all GZipped archives in place.<\/li><\/ul>\n\n\n\n<figure class=\"wp-block-image\"><img loading=\"lazy\" width=\"558\" height=\"262\" src=\"http:\/\/3.88.229.156\/wp-content\/uploads\/2019\/04\/powerlog_output.png\" alt=\"\" class=\"wp-image-97\" srcset=\"http:\/\/172.31.17.250\/wp-content\/uploads\/2019\/04\/powerlog_output.png 558w, http:\/\/172.31.17.250\/wp-content\/uploads\/2019\/04\/powerlog_output-300x141.png 300w\" sizes=\"(max-width: 558px) 100vw, 558px\" \/><\/figure>\n\n\n\n<p>In part 2, we will look at several different options for amalgamating this data in preparation for running Sarah&#8217;s PowerLog scripts against the entire dataset instead of having to do this manually for each one.<\/p>\n","protected":false},"excerpt":{"rendered":"<p>Building on the work of Sarah Edwards to re-unify the PowerLog database with C# before running APOLLO.<\/p>\n","protected":false},"author":2,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"_mi_skip_tracking":false},"categories":[27,26,1],"tags":[10,8,13,11,9,12],"yoast_head":"<!-- This site is optimized with the Yoast SEO plugin v19.4 - https:\/\/yoast.com\/wordpress\/plugins\/seo\/ -->\n<title>Aggregating iOS PowerLog data using C# - Part 1 - forensicmike1<\/title>\n<meta name=\"robots\" content=\"index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1\" \/>\n<link rel=\"canonical\" href=\"https:\/\/forensicmike1.com\/2019\/04\/28\/aggregating-ios-powerlog-data-using-c-part-1\/\" \/>\n<meta property=\"og:locale\" content=\"en_US\" \/>\n<meta property=\"og:type\" content=\"article\" \/>\n<meta property=\"og:title\" content=\"Aggregating iOS PowerLog data using C# - Part 1 - forensicmike1\" \/>\n<meta property=\"og:description\" content=\"Building on the work of Sarah Edwards to re-unify the PowerLog database with C# before running APOLLO.\" \/>\n<meta property=\"og:url\" content=\"https:\/\/forensicmike1.com\/2019\/04\/28\/aggregating-ios-powerlog-data-using-c-part-1\/\" \/>\n<meta property=\"og:site_name\" content=\"forensicmike1\" \/>\n<meta property=\"article:published_time\" content=\"2019-04-28T14:32:50+00:00\" \/>\n<meta property=\"article:modified_time\" content=\"2019-05-20T01:49:25+00:00\" \/>\n<meta property=\"og:image\" content=\"http:\/\/3.88.229.156\/wp-content\/uploads\/2019\/04\/powerlog_output.png\" \/>\n<meta name=\"author\" content=\"Mike Williamson\" \/>\n<meta name=\"twitter:card\" content=\"summary_large_image\" \/>\n<meta name=\"twitter:creator\" content=\"@forensicmike1\" \/>\n<meta name=\"twitter:label1\" content=\"Written by\" \/>\n\t<meta name=\"twitter:data1\" content=\"Mike Williamson\" \/>\n\t<meta name=\"twitter:label2\" content=\"Est. reading time\" \/>\n\t<meta name=\"twitter:data2\" content=\"4 minutes\" \/>\n<script type=\"application\/ld+json\" class=\"yoast-schema-graph\">{\"@context\":\"https:\/\/schema.org\",\"@graph\":[{\"@type\":\"WebSite\",\"@id\":\"http:\/\/172.31.17.250\/#website\",\"url\":\"http:\/\/172.31.17.250\/\",\"name\":\"forensicmike1\",\"description\":\"#DFIR | #RE | #OtherGeekThings =&gt; Views expressed are my own.\",\"potentialAction\":[{\"@type\":\"SearchAction\",\"target\":{\"@type\":\"EntryPoint\",\"urlTemplate\":\"http:\/\/172.31.17.250\/?s={search_term_string}\"},\"query-input\":\"required name=search_term_string\"}],\"inLanguage\":\"en-US\"},{\"@type\":\"WebPage\",\"@id\":\"https:\/\/forensicmike1.com\/2019\/04\/28\/aggregating-ios-powerlog-data-using-c-part-1\/\",\"url\":\"https:\/\/forensicmike1.com\/2019\/04\/28\/aggregating-ios-powerlog-data-using-c-part-1\/\",\"name\":\"Aggregating iOS PowerLog data using C# - Part 1 - forensicmike1\",\"isPartOf\":{\"@id\":\"http:\/\/172.31.17.250\/#website\"},\"datePublished\":\"2019-04-28T14:32:50+00:00\",\"dateModified\":\"2019-05-20T01:49:25+00:00\",\"author\":{\"@id\":\"http:\/\/172.31.17.250\/#\/schema\/person\/9452bbb839546322f3705877143ce492\"},\"breadcrumb\":{\"@id\":\"https:\/\/forensicmike1.com\/2019\/04\/28\/aggregating-ios-powerlog-data-using-c-part-1\/#breadcrumb\"},\"inLanguage\":\"en-US\",\"potentialAction\":[{\"@type\":\"ReadAction\",\"target\":[\"https:\/\/forensicmike1.com\/2019\/04\/28\/aggregating-ios-powerlog-data-using-c-part-1\/\"]}]},{\"@type\":\"BreadcrumbList\",\"@id\":\"https:\/\/forensicmike1.com\/2019\/04\/28\/aggregating-ios-powerlog-data-using-c-part-1\/#breadcrumb\",\"itemListElement\":[{\"@type\":\"ListItem\",\"position\":1,\"name\":\"Home\",\"item\":\"http:\/\/172.31.17.250\/\"},{\"@type\":\"ListItem\",\"position\":2,\"name\":\"Aggregating iOS PowerLog data using C# &#8211; Part 1\"}]},{\"@type\":\"Person\",\"@id\":\"http:\/\/172.31.17.250\/#\/schema\/person\/9452bbb839546322f3705877143ce492\",\"name\":\"Mike Williamson\",\"image\":{\"@type\":\"ImageObject\",\"inLanguage\":\"en-US\",\"@id\":\"http:\/\/172.31.17.250\/#\/schema\/person\/image\/\",\"url\":\"http:\/\/2.gravatar.com\/avatar\/540f47dd0fb41a572604e4bf8594c723?s=96&d=mm&r=g\",\"contentUrl\":\"http:\/\/2.gravatar.com\/avatar\/540f47dd0fb41a572604e4bf8594c723?s=96&d=mm&r=g\",\"caption\":\"Mike Williamson\"},\"sameAs\":[\"https:\/\/3.88.229.156\",\"https:\/\/twitter.com\/forensicmike1\"],\"url\":\"http:\/\/172.31.17.250\/author\/forensicmike\/\"}]}<\/script>\n<!-- \/ Yoast SEO plugin. -->","yoast_head_json":{"title":"Aggregating iOS PowerLog data using C# - Part 1 - forensicmike1","robots":{"index":"index","follow":"follow","max-snippet":"max-snippet:-1","max-image-preview":"max-image-preview:large","max-video-preview":"max-video-preview:-1"},"canonical":"https:\/\/forensicmike1.com\/2019\/04\/28\/aggregating-ios-powerlog-data-using-c-part-1\/","og_locale":"en_US","og_type":"article","og_title":"Aggregating iOS PowerLog data using C# - Part 1 - forensicmike1","og_description":"Building on the work of Sarah Edwards to re-unify the PowerLog database with C# before running APOLLO.","og_url":"https:\/\/forensicmike1.com\/2019\/04\/28\/aggregating-ios-powerlog-data-using-c-part-1\/","og_site_name":"forensicmike1","article_published_time":"2019-04-28T14:32:50+00:00","article_modified_time":"2019-05-20T01:49:25+00:00","og_image":[{"url":"http:\/\/3.88.229.156\/wp-content\/uploads\/2019\/04\/powerlog_output.png"}],"author":"Mike Williamson","twitter_card":"summary_large_image","twitter_creator":"@forensicmike1","twitter_misc":{"Written by":"Mike Williamson","Est. reading time":"4 minutes"},"schema":{"@context":"https:\/\/schema.org","@graph":[{"@type":"WebSite","@id":"http:\/\/172.31.17.250\/#website","url":"http:\/\/172.31.17.250\/","name":"forensicmike1","description":"#DFIR | #RE | #OtherGeekThings =&gt; Views expressed are my own.","potentialAction":[{"@type":"SearchAction","target":{"@type":"EntryPoint","urlTemplate":"http:\/\/172.31.17.250\/?s={search_term_string}"},"query-input":"required name=search_term_string"}],"inLanguage":"en-US"},{"@type":"WebPage","@id":"https:\/\/forensicmike1.com\/2019\/04\/28\/aggregating-ios-powerlog-data-using-c-part-1\/","url":"https:\/\/forensicmike1.com\/2019\/04\/28\/aggregating-ios-powerlog-data-using-c-part-1\/","name":"Aggregating iOS PowerLog data using C# - Part 1 - forensicmike1","isPartOf":{"@id":"http:\/\/172.31.17.250\/#website"},"datePublished":"2019-04-28T14:32:50+00:00","dateModified":"2019-05-20T01:49:25+00:00","author":{"@id":"http:\/\/172.31.17.250\/#\/schema\/person\/9452bbb839546322f3705877143ce492"},"breadcrumb":{"@id":"https:\/\/forensicmike1.com\/2019\/04\/28\/aggregating-ios-powerlog-data-using-c-part-1\/#breadcrumb"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https:\/\/forensicmike1.com\/2019\/04\/28\/aggregating-ios-powerlog-data-using-c-part-1\/"]}]},{"@type":"BreadcrumbList","@id":"https:\/\/forensicmike1.com\/2019\/04\/28\/aggregating-ios-powerlog-data-using-c-part-1\/#breadcrumb","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"http:\/\/172.31.17.250\/"},{"@type":"ListItem","position":2,"name":"Aggregating iOS PowerLog data using C# &#8211; Part 1"}]},{"@type":"Person","@id":"http:\/\/172.31.17.250\/#\/schema\/person\/9452bbb839546322f3705877143ce492","name":"Mike Williamson","image":{"@type":"ImageObject","inLanguage":"en-US","@id":"http:\/\/172.31.17.250\/#\/schema\/person\/image\/","url":"http:\/\/2.gravatar.com\/avatar\/540f47dd0fb41a572604e4bf8594c723?s=96&d=mm&r=g","contentUrl":"http:\/\/2.gravatar.com\/avatar\/540f47dd0fb41a572604e4bf8594c723?s=96&d=mm&r=g","caption":"Mike Williamson"},"sameAs":["https:\/\/3.88.229.156","https:\/\/twitter.com\/forensicmike1"],"url":"http:\/\/172.31.17.250\/author\/forensicmike\/"}]}},"_links":{"self":[{"href":"http:\/\/172.31.17.250\/wp-json\/wp\/v2\/posts\/80"}],"collection":[{"href":"http:\/\/172.31.17.250\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"http:\/\/172.31.17.250\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"http:\/\/172.31.17.250\/wp-json\/wp\/v2\/users\/2"}],"replies":[{"embeddable":true,"href":"http:\/\/172.31.17.250\/wp-json\/wp\/v2\/comments?post=80"}],"version-history":[{"count":24,"href":"http:\/\/172.31.17.250\/wp-json\/wp\/v2\/posts\/80\/revisions"}],"predecessor-version":[{"id":105,"href":"http:\/\/172.31.17.250\/wp-json\/wp\/v2\/posts\/80\/revisions\/105"}],"wp:attachment":[{"href":"http:\/\/172.31.17.250\/wp-json\/wp\/v2\/media?parent=80"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"http:\/\/172.31.17.250\/wp-json\/wp\/v2\/categories?post=80"},{"taxonomy":"post_tag","embeddable":true,"href":"http:\/\/172.31.17.250\/wp-json\/wp\/v2\/tags?post=80"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}